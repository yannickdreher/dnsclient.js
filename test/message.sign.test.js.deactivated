import * as dnsclient from '../src/dnsclient.js';

describe('Message should be serialized correctly', () => {
    let message = new dnsclient.UpdateMessage();
    message.id  = 1234;

    message.zones.push(new dnsclient.Zone("example.com"));
    message.prerequisites.push(new dnsclient.Record("test.example.com", dnsclient.TYPE.A, dnsclient.CLAZZ.ANY, 0));
    message.updates.push(new dnsclient.Record("test.example.com", dnsclient.TYPE.A, dnsclient.CLAZZ.ANY, 0));
    message.updates.push(new dnsclient.Record("test.example.com", dnsclient.TYPE.A, dnsclient.CLAZZ.IN, 8600, [{key: "ipv4", value: "192.0.2.1"}]));
    
    message.zcount  = message.zones.length;
    message.prcount = message.prerequisites.length;
    message.upcount = message.updates.length;

    const edata = new Uint8Array([
        0x04, 0xD2, 0x01, 0x00,  // Header
        0x00, 0x01, 0x00, 0x01,  // Fragen / Antworten
        0x00, 0x01, 0x00, 0x01,  // AutoritÃ¤t / Zusatz
        //questions
        0x07, 0x65, 0x78, 0x61,  // "example"
        0x6D, 0x70, 0x6C, 0x65,  
        0x03, 0x63, 0x6F, 0x6D,  // "com"
        0x00,                    // Nullterminierung der Domain
        0x00, 0x01,              // Typ A (IPv4-Adresse)
        0x00, 0x01,              // Klasse IN (Internet)
        //answer
        0x07, 0x65, 0x78, 0x61,  // "example"
        0x6D, 0x70, 0x6C, 0x65,  
        0x03, 0x63, 0x6F, 0x6D,  // "com"
        0x00,                    // Nullterminierung der Domain
        0x00, 0x01,              // Typ A (IPv4-Adresse)
        0x00, 0x01,              // Klasse IN (Internet)
        0x00, 0x00, 0x21, 0x98,  // TTL 8600
        0x00, 0x04,              // Data Length
        0xC0, 0x00, 0x02, 0x01,  // 192.0.2.1
        //authorities
        0x07, 0x65, 0x78, 0x61,  // "example"
        0x6D, 0x70, 0x6C, 0x65,  
        0x03, 0x63, 0x6F, 0x6D,  // "com"
        0x00,                    // Nullterminierung der Domain
        0x00, 0x01,              // Typ A (IPv4-Adresse)
        0x00, 0x01,              // Klasse IN (Internet)
        0x00, 0x00, 0x21, 0x98,  // TTL 8600
        0x00, 0x04,              // Data Length
        0xC0, 0x00, 0x02, 0x01,  // 192.0.2.1
        //additionals
        0x07, 0x65, 0x78, 0x61,  // "example"
        0x6D, 0x70, 0x6C, 0x65,  
        0x03, 0x63, 0x6F, 0x6D,  // "com"
        0x00,                    // Nullterminierung der Domain
        0x00, 0x01,              // Typ A (IPv4-Adresse)
        0x00, 0x01,              // Klasse IN (Internet)
        0x00, 0x00, 0x21, 0x98,  // TTL 8600
        0x00, 0x04,              // Data Length
        0xC0, 0x00, 0x02, 0x01,  // 192.0.2.1
    ]);
    
    beforeAll(async () => {
        message = await dnsclient.sign(message, "test", "RGFzSXN0RWluVGVzdA==");
        console.dir(message, {depth: null});
    });

    const serialized = dnsclient.DnsSerializer.serialize(message);
    console.log(serialized);

    test('Expect buffer length to be correct', () => {
        expect(serialized.byteLength).toBe(107);
    });
});